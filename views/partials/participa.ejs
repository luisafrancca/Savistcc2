<form
  id="formParticipante"
  action="<%= action %>"
  method="POST"
  class="container mt-4"
  enctype="multipart/form-data"
  novalidate
  data-ocupacao="<%= ocupacao %>"
  data-lugares="<%= viagem.veiculo.lugares_dispo %>"
>
  <h2 class="mb-4 titulo">Formulário do Participante</h2>

  <input type="hidden" name="usuarioID" value="<%= usuario.cod %>" /> 
  <input type="hidden" name="viagemID" value="<%= viagem.cod %>" />
  <input type="hidden" name="cidadeconsulID" value="<%= viagem.cidadeconsulID %>" />
  <input type="hidden" name="data_consul" value="<%= viagem.data_viagem %>" />

  <!-- Hospital -->
  <div class="mb-3">
    <label class="form-label">Local (Hospital, Clínica...)</label>
    <input
      type="text"
      id="local_consul"
      name="local_consul"
      class="form-control <%= erros?.local_consul ? 'is-invalid' : '' %>"
      maxlength="100"
      placeholder="Digite o local da consulta"
      value="<%= preenchido?.local_consul || '' %>"
    />
  </div>

  <!-- Horário -->
  <div class="mb-3">
    <label class="form-label">Horário da Consulta</label>
    <input
      type="time"
      id="hora_consul"
      name="hora_consul"
      class="form-control <%= erros?.hora_consul ? 'is-invalid' : '' %>"
      value="<%= preenchido?.hora_consul || '' %>"
    />
  </div>

  <!-- Encaminhamento -->
  <div class="mb-3">
    <label class="form-label">Encaminhamento (PDF)</label>
    <input
      type="file"
      id="encaminhamento"
      name="encaminhamento"
      accept="application/pdf"
      class="form-control <%= erros?.encaminhamento ? 'is-invalid' : '' %>"
    />
  </div>

  <!-- Objetivo -->
  <div class="mb-3">
    <label class="form-label">Objetivo da Consulta</label>
    <input
      type="text"
      id="objetivo"
      name="objetivo"
      class="form-control <%= erros?.objetivo ? 'is-invalid' : '' %>"
      maxlength="60"
      placeholder="Digite o objetivo da consulta"
      value="<%= preenchido?.objetivo || '' %>"
    />
  </div>

  <div class="mb-3">
    <label for="obs" class="form-label">Observações</label>
    <textarea
      id="obs"
      name="obs"
      class="form-control"
      rows="3"
      placeholder="Escreva aqui observações adicionais"
    ><%= preenchido?.obs || '' %></textarea>
  </div>

  <!-- Acompanhante -->
  <div class="mb-3">
    <label class="form-label me-2">Acompanhante</label>
    <input
      type="radio"
      id="temAcompSim"
      name="temAcompanhante"
      value="sim"
      <%= preenchido?.temAcompanhante === 'sim' ? 'checked' : '' %>
      onclick="toggleCamposAcomp()"
    /> Sim
    <input
      type="radio"
      id="temAcompNao"
      name="temAcompanhante"
      value="nao"
      <%= preenchido?.temAcompanhante !== 'sim' ? 'checked' : '' %>
      onclick="toggleCamposAcomp()"
    /> Não
  </div>

  <!-- Campos do acompanhante -->
  <div id="camposAcompanhante" style="display: none">
    <div class="text-center">
      <label for="foto_acompanhante">
        <img
          id="preview_foto_acompanhante"
          src="/assets/default-profile.jpg"
          alt="Foto do acompanhante"
          class="rounded-circle mt-3 mb-2"
          style="
            width: 90px;
            height: 90px;
            object-fit: cover;
            cursor: pointer;
            border: 2px solid #ccc;
          "
        />
      </label>
      <input
        type="file"
        id="foto_acompanhante"
        name="foto_acompanhante"
        accept="image/*"
        class="d-none"
        onchange="previewImagemAcompanhante(event)"
      />
    </div>

    <div class="mb-3">
      <label class="form-label">Nome</label>
      <input
        type="text"
        id="nome_acomp"
        name="nome_acomp"
        class="form-control <%= erros?.nome_acomp ? 'is-invalid' : '' %>"
        maxlength="100"
        placeholder="Digite o nome completo do acompanhante"
        value="<%= preenchido?.nome_acomp || '' %>"
      />
    </div>

    <div class="mb-3">
      <label class="form-label">CPF</label>
      <input
        type="text"
        id="cpf_acomp"
        name="cpf_acomp"
        class="form-control <%= erros?.cpf_acomp ? 'is-invalid' : '' %>"
        maxlength="14"
        placeholder="Digite o CPF do acompanhante"
        value="<%= preenchido?.cpf_acomp || '' %>"
      />
      <% if (typeof erros?.cpf_acomp === 'string') { %>
        <div class="invalid-feedback"><%= erros.cpf_acomp %></div>
      <% } %>
    </div>

    <div class="mb-3">
      <label class="form-label">Data de Nascimento</label>
      <input
        type="date"
        id="data_nasc_acomp"
        name="data_nasc_acomp"
        class="form-control <%= erros?.data_nasc_acomp ? 'is-invalid' : '' %>"
        value="<%= preenchido?.data_nasc_acomp || '' %>"
      />
      <% if (typeof erros?.data_nasc_acomp === 'string') { %>
        <div class="invalid-feedback"><%= erros.data_nasc_acomp %></div>
      <% } %>
    </div>

    <div class="mb-3">
      <label class="form-label">Telefone</label>
      <input
        type="text"
        id="telefone_acomp"
        name="telefone_acomp"
        class="form-control <%= erros?.telefone_acomp ? 'is-invalid' : '' %>"
        maxlength="15"
        placeholder="Digite o número do acompanhante"
        value="<%= preenchido?.telefone_acomp || '' %>"
      />
      <% if (typeof erros?.telefone_acomp === 'string') { %>
        <div class="invalid-feedback"><%= erros.telefone_acomp %></div>
      <% } %>
    </div>

    <div class="mb-3">
      <label class="form-label">Gênero</label>
      <select
        name="generoID"
        id="generoID"
        class="form-control <%= erros?.generoID ? 'is-invalid' : '' %>"
      >
        <option value="" disabled <%= !preenchido?.generoID ? 'selected' : '' %>>Selecione</option>
        <option value="1" <%= preenchido?.generoID == 1 ? 'selected' : '' %>>Masculino</option>
        <option value="2" <%= preenchido?.generoID == 2 ? 'selected' : '' %>>Feminino</option>
        <option value="3" <%= preenchido?.generoID == 3 ? 'selected' : '' %>>Não-Binário</option>
        <option value="4" <%= preenchido?.generoID == 4 ? 'selected' : '' %>>Outro</option>
      </select>
    </div>
  </div>

  <div class="mb-3 d-flex justify-content-end">
    <button type="submit" class="botao">
      <%= modo === 'usuario' ? 'Submeter' : 'Vincular' %>
    </button>
  </div>
</form>

<script>
  function previewImagemAcompanhante(event) {
    const input = event.target;
    const img = document.getElementById("preview_foto_acompanhante");
    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function (e) {
        img.src = e.target.result;
      };
      reader.readAsDataURL(input.files[0]);
    }
  }

  function toggleCamposAcomp() {
    const form = document.getElementById("formParticipante");
    const sim = document.getElementById("temAcompSim").checked;
    const campos = document.getElementById("camposAcompanhante");

    const ocupacao = parseInt(form.dataset.ocupacao);
    const lugares = parseInt(form.dataset.lugares);

    if (sim) {
      if (ocupacao >= lugares - 1) {
        alert("Esta viagem não comporta mais um acompanhante.");
        document.getElementById("temAcompNao").checked = true;
        campos.style.display = "none";
      } else {
        campos.style.display = "block";
      }
    } else {
      campos.style.display = "none";
    }
  }

  document.getElementById("cpf_acomp").addEventListener("input", (e) => {
    let v = e.target.value.replace(/\D/g, "");
    v = v.replace(/^(\d{3})(\d)/, "$1.$2");
    v = v.replace(/^(\d{3})\.(\d{3})(\d)/, "$1.$2.$3");
    v = v.replace(/\.(\d{3})(\d)/, ".$1-$2");
    e.target.value = v;
  });

  document.getElementById("telefone_acomp").addEventListener("input", (e) => {
    let v = e.target.value.replace(/\D/g, "");
    if (v.length > 10) v = v.replace(/^(\d{2})(\d{5})(\d{4})$/, "($1) $2-$3");
    else v = v.replace(/^(\d{2})(\d{4})(\d{4})$/, "($1) $2-$3");
    e.target.value = v;
  });

  // Exibir automaticamente os campos do acompanhante se já estiver preenchido
  window.addEventListener("DOMContentLoaded", () => {
    if (document.getElementById("temAcompSim").checked) toggleCamposAcomp();
  });
</script>
