<div class="container mt-5">
  <div class="row justify-content-center mb-5">
    <form action="/admin/usuarios/index" method="GET" class="d-flex justify-content-center align-items-center mb-4" style="gap: 10px;">
      <input
        type="search"
        name="q"
        value="<%= termoPesquisa %>"
        placeholder="Pesquisar usuário por nome ou CPF"
        class="form-control pesquisa-custom"
      />
      <a href="/auth/cadastro/etapa1" class="botao-cadastro">Cadastrar Usuário</a>
    </form>

    <% posts.forEach(function(post) { %>
      <div class="col-12 d-flex justify-content-center">
        <div class="card p-3 shadow-sm mt-2 card-viagem">
          <div class="d-flex flex-row align-items-center">
            <img
              src="<%= post.img ? '/uploads/' + post.img : '/assets/default-profile.jpg' %>"
              alt="Foto de perfil"
              class="foto-perfil me-3"
            />

            <div class="flex-grow-1">
              <h5 class="nome-perfil mb-0"><%= post.nome %></h5>
            </div>

            <button class="botao ver-mais-btn">Ver mais</button>
          </div>

          <div class="detalhes">
            <p><strong>Data de Nascimento:</strong> <%= post.data_nasc.split('-').reverse().join('/') %></p>
            <hr>
            <p><strong>CPF:</strong> <span class="cpf-perfil"><%= post.CPF.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/, "$1.$2.$3-$4") %></span></p>
            <hr>
            <p><strong>Gênero:</strong> <%= post.genero.descricao %></p>
            <hr>
            <% if (post.email) { %> 
            <p><strong>Email:</strong> <%= post.email %></p>
            <hr>
            <% } %>
            <p><strong>Telefone:</strong> <%= post.fone.replace(/^(\d{2})(\d{5})(\d{4})$/, "($1) $2-$3") %></p>
            <hr>
            <p><strong>Endereço:</strong>
              <%= post.endereco?.rua || '' %>,
              <%= post.endereco?.numero || '' %> -
              <%= post.endereco?.bairro || '' %> -
              <%= post.endereco?.cidade || '' %>
              (<%= post.endereco?.UF || '' %>)
              CEP: <%= post.endereco?.CEP ? post.endereco.CEP.replace(/^(\d{5})(\d{3})$/, "$1-$2") : '' %>
            </p>
            <hr>
            <p><strong>SUS:</strong> <%= post.SUS %></p>
            <hr>

            <div class="d-flex justify-content-end gap-3">
              <a href="/admin/usuarios/editar/<%= post.cod %>" class="botao">Editar</a>
              <!--
              <form action="/admin/usuarios/deletar/<%= post.cod %>?_method=DELETE" method="POST">
                <button type="submit" class="botao bg-vermelho" onclick="return confirm('Tem certeza que deseja deletar este usuário?')">
                  Excluir
                </button>
              </form>
              -->
            </div>
          </div>
        </div>
      </div>
    <% }) %>
    
    <% if (posts.length === 0) { %>
      <p class="text-center text-muted mt-4">Nenhum usuário encontrado.</p>
    <% } else { %>
  
      <div class="d-flex justify-content-center mt-4">
        <% if (paginaNun > 1) { %>
          <a href="?page=<%= paginaNun - 1 %>&q=<%= termoPesquisa %>" class="botao-paginacao">
            ‹
          </a>
        <% } else { %>
          <button class="botao-paginacao" disabled>‹</button>
        <% } %>

        <% for (let i = 1; i <= totalPaginas; i++) { %>
          <a
            href="?page=<%= i %>&q=<%= termoPesquisa %>"
            class="botao-paginacao <%= i === paginaNun ? 'ativo' : '' %>"
          >
            <%= i %>
          </a>
        <% } %>

        <% if (paginaNun < totalPaginas) { %>
          <a href="?page=<%= paginaNun + 1 %>&q=<%= termoPesquisa %>" class="botao-paginacao">
            ›
          </a>
        <% } else { %>
          <button class="botao-paginacao" disabled>›</button>
        <% } %>
      </div>
    <% } %>
  </div>
</div>

<% if (sucesso) { %>
        <script>
          alert('Cadastro realizado com sucesso!');
        </script>
<% } %>

<script>
  // VER MAIS / VER MENOS
  document.querySelectorAll('.ver-mais-btn').forEach(btn => {
    btn.addEventListener('click', function () {
      const card = this.closest('.card');
      const detalhes = card.querySelector('.detalhes');
      const estaExpandido = detalhes.classList.contains('expandido');

      if (estaExpandido) {
        detalhes.style.height = '0px';
        detalhes.style.marginTop = '0';
        detalhes.classList.remove('expandido');
        this.textContent = 'Ver mais';
      } else {
        detalhes.style.height = detalhes.scrollHeight + 'px';
        detalhes.style.marginTop = '16px';
        detalhes.classList.add('expandido');
        this.textContent = 'Ver menos';
      }
    });
  });
  
</script>
